/**
 * Scratch Pad Extension Styles
 * Full-screen drawer UI with mobile support
 */

/* ========================================
   CSS Variables
   ======================================== */
:root {
    /* ===== SillyTavern Theme Integration with Purple Accent ===== */
    /* Original purple palette colors */
    --sp-purple-primary: #1a1a2e;
    --sp-purple-secondary: #16213e;
    --sp-purple-tertiary: #0f0f1a;
    --sp-purple-accent: #6366f1;

    /* Background colors - blend original purple with ST theme for distinctive look */
    --sp-bg-primary: color-mix(in srgb, var(--SmartThemeBlurTintColor, #1a1a2e) 60%, var(--sp-purple-primary) 40%);
    --sp-bg-secondary: color-mix(in srgb, var(--SmartThemeBlurTintColor, #16213e) 50%, var(--sp-purple-secondary) 50%);
    --sp-bg-tertiary: color-mix(in srgb, var(--SmartThemeBlurTintColor, #0f0f1a) 50%, var(--sp-purple-tertiary) 50%);

    /* Text colors from ST theme */
    --sp-text-primary: var(--SmartThemeBodyColor, #e4e4e7);
    --sp-text-secondary: var(--SmartThemeEmColor, #a1a1aa);
    --sp-text-muted: color-mix(in srgb, var(--SmartThemeEmColor, #71717a) 60%, var(--SmartThemeBlurTintColor, #1a1a2e) 40%);

    /* Accent colors - blend ST accent with purple for unique branded look */
    --sp-accent: color-mix(in srgb, var(--SmartThemeQuoteColor, #6366f1) 70%, var(--sp-purple-accent) 30%);
    --sp-accent-hover: color-mix(in srgb, var(--sp-accent) 80%, var(--SmartThemeBodyColor, #e4e4e7) 20%);

    /* Border - subtle purple tint added */
    --sp-border: color-mix(in srgb, var(--SmartThemeBorderColor, rgba(39, 39, 58, 1)) 80%, var(--sp-purple-accent) 20%);

    /* Message backgrounds from ST's user/bot tints */
    --sp-user-msg-bg: var(--SmartThemeUserMesBlurTintColor, rgba(55, 48, 163, 1));
    --sp-assistant-msg-bg: var(--SmartThemeBotMesBlurTintColor, rgba(30, 30, 46, 1));

    /* Semantic colors (kept for clarity, with fallbacks) */
    --sp-error: #ef4444;
    --sp-success: #22c55e;
    --sp-warning: #f59e0b;

    /* Shadow using ST shadow color */
    --sp-shadow: 0 4px 6px -1px var(--SmartThemeShadowColor, rgba(0, 0, 0, 0.5));

    /* Layout variables (unchanged) */
    --sp-radius: 0.5rem;
    --sp-radius-lg: 0.75rem;
    --sp-transition: 0.2s ease;
    --sp-drawer-width: min(400px, 100vw);
    --sp-min-touch-target: 2.75rem;

    /* Typography - inherit from ST if available */
    --sp-text-size: var(--mainFontSize, 14px);
}

/* ========================================
   Body Lock when drawer open
   ======================================== */
body.sp-drawer-open:not(.sp-drawer-pinned) {
    overflow: hidden;
}

/* ========================================
   Drawer
   ======================================== */
.sp-drawer {
    position: fixed;
    /* Use inset for positioning */
    inset: 0 0 0 auto;
    width: 100%;
    max-width: var(--sp-drawer-width);
    /* Explicit viewport height - !important to override any inherited issues */
    height: 100vh !important;
    height: 100dvh !important;
    min-height: 100vh !important;
    min-height: 100dvh !important;
    background: var(--sp-bg-primary);
    z-index: 99999;
    /* Very high to overlay SillyTavern UI */
    transform: translateX(100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 20px var(--SmartThemeShadowColor, rgba(0, 0, 0, 0.5));
    overflow: hidden;
    font-family: var(--mainFontFamily, 'Noto Sans', sans-serif);
}

.sp-drawer.open {
    transform: translateX(0) !important;
}

/* Mobile: Full width drawer with backdrop */
@media (max-width: 30rem) {
    .sp-drawer {
        max-width: 100% !important;
        width: 100% !important;
        inset: 0 !important;
    }
}

/* Backdrop overlay when drawer is open */
.sp-drawer-backdrop {
    position: fixed;
    inset: 0;
    /* Explicit viewport dimensions */
    width: 100vw !important;
    height: 100vh !important;
    height: 100dvh !important;
    background: rgba(0, 0, 0, 0.6);
    z-index: 99998;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    display: block;
}

.sp-drawer-backdrop.visible {
    opacity: 1;
    pointer-events: auto;
}

/* Pinned Mode */
body.sp-drawer-pinned .sp-drawer-backdrop {
    display: none !important;
}

.sp-drawer.sp-pinned {
    transform: translateX(0) !important;
}

/* Pin button */
.sp-button.sp-pin-btn {
    background: transparent;
    border: none;
    color: var(--sp-text-secondary);
    padding: 0.5rem;
    cursor: pointer;
    border-radius: var(--sp-radius);
}

.sp-button.sp-pin-btn:hover {
    background: var(--sp-bg-tertiary);
    color: var(--sp-text-primary);
}

.sp-button.sp-pin-btn.sp-pinned-active {
    color: var(--sp-accent);
}

/* Hide pin on mobile */
@media (max-width: 30rem) {
    .sp-button.sp-pin-btn { display: none !important; }
}

/* ========================================
   Fullscreen Mode
   ======================================== */

/* Body lock */
body.sp-fullscreen-open {
    overflow: hidden;
}

/* Overlay backdrop */
.sp-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(var(--SmartThemeBlurStrength, 4px));
    -webkit-backdrop-filter: blur(var(--SmartThemeBlurStrength, 4px));
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Remove expensive backdrop-filter blur on touch/mobile devices */
@media (hover: none) and (pointer: coarse) {
    .sp-overlay {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: rgba(0, 0, 0, 0.82);
    }
}

.sp-overlay.visible {
    opacity: 1;
}

/* Modal container */
.sp-fullscreen {
    display: flex;
    flex-direction: column;
    max-width: var(--sheldWidth, 1200px);
    width: calc(100vw - 4rem);
    max-height: calc(100dvh - 4rem);
    height: calc(100dvh - 4rem);
    position: absolute;
    inset: 0;
    margin: auto;
    background: var(--sp-bg-primary);
    border: 1px solid var(--sp-border);
    border-radius: var(--sp-radius-lg);
    box-shadow: 0 0 30px var(--SmartThemeShadowColor, rgba(0, 0, 0, 0.6));
    overflow: hidden;
}

/* Fullscreen header */
.sp-fullscreen-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--sp-bg-secondary);
    border-bottom: 1px solid var(--sp-border);
    flex-shrink: 0;
}

/* Split layout body */
.sp-fullscreen-body {
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

/* Sidebar (thread list) */
.sp-fullscreen-sidebar {
    width: 280px;
    border-right: 1px solid var(--sp-border);
    overflow: hidden;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
}

.sp-fullscreen-sidebar .sp-drawer-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
    min-height: 0;
}

/* Main conversation area */
.sp-fullscreen-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
}

.sp-fullscreen-main .sp-drawer-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
    min-height: 0;
}

/* Empty state for main panel */
.sp-fullscreen-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--sp-text-muted);
    text-align: center;
    padding: 2rem;
    gap: 1rem;
}

.sp-fullscreen-empty .sp-empty-icon {
    font-size: 3rem;
    opacity: 0.4;
}

/* Element suppression in fullscreen */
.sp-fullscreen-main .sp-back-btn {
    display: none;
}

.sp-fullscreen-sidebar .sp-pin-btn,
.sp-fullscreen-main .sp-pin-btn,
.sp-fullscreen-sidebar .sp-close-btn,
.sp-fullscreen-main .sp-close-btn {
    display: none;
}

/* Scrollbar styling for fullscreen panels */
.sp-fullscreen-sidebar .sp-thread-list::-webkit-scrollbar,
.sp-fullscreen-main .sp-messages::-webkit-scrollbar {
    width: 0.375rem;
}

.sp-fullscreen-sidebar .sp-thread-list::-webkit-scrollbar-track,
.sp-fullscreen-main .sp-messages::-webkit-scrollbar-track {
    background: transparent;
}

.sp-fullscreen-sidebar .sp-thread-list::-webkit-scrollbar-thumb,
.sp-fullscreen-main .sp-messages::-webkit-scrollbar-thumb {
    background: var(--sp-border);
    border-radius: 0.1875rem;
}

/* Mobile fullscreen (<=48rem / 768px) */
@media (max-width: 48rem) {
    .sp-fullscreen {
        width: 100vw;
        max-width: 100vw;
        max-height: 100dvh;
        height: 100dvh;
        min-height: 100dvh;
        border-radius: 0;
        margin: 0;
        border: none;
    }

    .sp-fullscreen-sidebar {
        width: 100%;
        max-width: 100%;
        border-right: none;
    }

    .sp-fullscreen-sidebar.sp-fs-hidden {
        display: none;
    }

    .sp-fullscreen-main.sp-fs-hidden {
        display: none;
    }

    .sp-fullscreen-main .sp-back-btn {
        display: inline-flex;
    }
}

/* Reduced motion for fullscreen */
@media (prefers-reduced-motion: reduce) {
    .sp-overlay {
        transition: none;
    }
}

.sp-drawer-content {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
    min-height: 0;
    /* Allow flex shrinking */
}

/* ========================================
   Header
   ======================================== */
.sp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: var(--sp-bg-secondary);
    border-bottom: 1px solid var(--sp-border);
    flex-shrink: 0;
}

.sp-conversation-header {
    gap: 0.75rem;
}

.sp-title {
    font-size: calc(var(--sp-text-size) * 1.15);
    font-weight: 600;
    color: var(--sp-text-primary);
    margin: 0;
}

.sp-subtitle {
    font-size: calc(var(--sp-text-size) * 0.75);
    color: var(--sp-accent);
    text-transform: uppercase;
    letter-spacing: 0.03rem;
}

.sp-title-container {
    flex: 1;
    min-width: 0;
}

.sp-thread-title {
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sp-thread-title:hover {
    color: var(--sp-accent);
}

/* ========================================
   Buttons
   ======================================== */
.sp-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    min-height: var(--sp-min-touch-target);
    min-width: var(--sp-min-touch-target);
    background: var(--sp-accent);
    color: white;
    border: none;
    border-radius: var(--sp-radius);
    font-size: var(--sp-text-size);
    font-weight: 500;
    cursor: pointer;
    transition: background var(--sp-transition);
}

.sp-button:hover:not(:disabled) {
    background: var(--sp-accent-hover);
}

.sp-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.sp-button-icon {
    font-size: 1rem;
}

.sp-close-btn,
.sp-back-btn,
.sp-ai-rename-btn {
    background: transparent;
    color: var(--sp-text-secondary);
    padding: 0.5rem;
}

.sp-close-btn:hover,
.sp-back-btn:hover,
.sp-ai-rename-btn:hover {
    background: var(--sp-bg-tertiary);
    color: var(--sp-text-primary);
}

.sp-ai-rename-btn {
    margin-left: auto;
    margin-right: 0.5rem;
}

.sp-action-btn {
    background: transparent;
    color: var(--sp-text-muted);
    padding: 0.5rem;
    min-width: 2.25rem;
    min-height: 2.25rem;
}

.sp-action-btn:hover {
    background: var(--sp-bg-tertiary);
    color: var(--sp-text-primary);
}

.sp-delete-btn:hover {
    color: var(--sp-error);
}

/* ========================================
   Action Bar
   ======================================== */
.sp-action-bar {
    display: flex;
    padding: 0.75rem 1rem;
    background: var(--sp-bg-secondary);
    border-bottom: 1px solid var(--sp-border);
}

.sp-new-thread-btn {
    flex: 1;
}

/* ========================================
   Thread List
   ======================================== */
.sp-thread-list-view {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-height: 0;
    overflow: hidden;
    height: 100%;
}

.sp-thread-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 0.5rem;
}

.sp-thread-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--sp-bg-secondary);
    border-radius: var(--sp-radius);
    border: 1px solid var(--sp-border);
    transition: all var(--sp-transition);
    position: relative;
    overflow: hidden;
}

.sp-thread-item:hover {
    border-color: var(--sp-accent);
}

.sp-thread-item-nocontext {
    border-color: color-mix(in srgb, var(--sp-warning) 40%, var(--sp-border));
}

.sp-thread-item.sp-swipe-delete {
    transform: translateX(-80px);
}

.sp-thread-item.sp-swipe-delete .sp-thread-actions {
    opacity: 1;
    transform: translateX(0);
}

.sp-thread-main {
    flex: 1;
    min-width: 0;
    cursor: pointer;
    padding: 0.25rem;
}

.sp-thread-name-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    min-width: 0;
}

.sp-thread-name-row .sp-thread-name {
    min-width: 0;
}

.sp-thread-name {
    font-size: calc(var(--sp-text-size) * 1.0);
    font-weight: 500;
    color: var(--sp-text-primary);
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sp-thread-preview {
    font-size: calc(var(--sp-text-size) * 0.85);
    color: var(--sp-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.25rem;
}

.sp-thread-time {
    font-size: calc(var(--sp-text-size) * 0.7);
    color: var(--sp-text-muted);
}

.sp-thread-actions {
    display: flex;
    gap: 0.25rem;
    margin-left: 0.5rem;
}

/* ========================================
   Empty State
   ======================================== */
.sp-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2.5rem 1.25rem;
    text-align: center;
    color: var(--sp-text-secondary);
}

.sp-empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.sp-empty-state p {
    margin: 0.25rem 0;
}

/* ========================================
   Quick Input (Thread List Bottom)
   ======================================== */
.sp-quick-input-container {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
    background: var(--sp-bg-secondary);
    border-top: 1px solid var(--sp-border);
    flex-shrink: 0;
}

.sp-quick-input {
    flex: 1;
    padding: 0.75rem;
    background: var(--sp-bg-tertiary);
    border: 1px solid var(--sp-border);
    border-radius: var(--sp-radius);
    color: var(--sp-text-primary);
    font-size: var(--sp-text-size);
    resize: none;
    min-height: var(--sp-min-touch-target);
}

.sp-quick-input:focus {
    outline: none;
    border-color: var(--sp-accent);
}

.sp-quick-input::placeholder {
    color: var(--sp-text-muted);
}

/* ========================================
   Conversation View
   ======================================== */
.sp-conversation-view {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-height: 0;
    overflow: hidden;
    height: 100%;
}

.sp-messages {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* ========================================
   Messages
   ======================================== */
.sp-message {
    max-width: 90%;
    padding: 0.75rem 1rem;
    border-radius: var(--sp-radius-lg);
    animation: sp-message-in 0.2s ease;
}

@keyframes sp-message-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.sp-message-user {
    align-self: flex-end;
    background: var(--sp-user-msg-bg);
    color: var(--sp-text-primary);
    border-bottom-right-radius: 4px;
}

.sp-message-assistant {
    align-self: flex-start;
    background: var(--sp-assistant-msg-bg);
    color: var(--sp-text-primary);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--sp-border);
}

.sp-message-role {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03rem;
    opacity: 0.7;
    color: var(--sp-text-muted);
    margin-bottom: 0.5rem;
}

.sp-message-role-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
}

.sp-message-badge {
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02rem;
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
    border: 1px solid var(--sp-border);
    opacity: 0.9;
    white-space: nowrap;
}

.sp-message-badge-nocontext {
    color: var(--sp-warning);
    background: color-mix(in srgb, var(--sp-warning) 15%, transparent);
    border-color: color-mix(in srgb, var(--sp-warning) 50%, var(--sp-border));
}

.sp-message-content {
    font-size: var(--sp-text-size);
    line-height: 1.6;
    word-wrap: break-word;
}

.sp-message-content p {
    margin: 0 0 0.5rem 0;
}

.sp-message-content p:last-child {
    margin-bottom: 0;
}

.sp-message-content code {
    background: rgba(0, 0, 0, 0.3);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
}

.sp-message-content pre {
    background: rgba(0, 0, 0, 0.3);
    padding: 0.75rem;
    border-radius: var(--sp-radius);
    overflow-x: auto;
    margin: 0.5rem 0;
}

.sp-message-content pre code {
    background: none;
    padding: 0;
}

.sp-message-time {
    font-size: 0.625rem;
    color: var(--sp-text-muted);
    margin-top: 0.5rem;
    text-align: right;
}

.sp-message-user .sp-message-time {
    color: var(--sp-text-muted);
}

/* Message Footer */
.sp-message-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    gap: 0.5rem;
}

.sp-message-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity var(--sp-transition);
}

.sp-message:hover .sp-message-actions {
    opacity: 1;
}

/* TTS Speak Button */
.sp-speak-btn {
    background: transparent;
    border: 1px solid var(--sp-border);
    color: var(--sp-text-secondary);
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.sp-speak-btn:hover:not(:disabled) {
    background: var(--sp-accent);
    border-color: var(--sp-accent);
    color: white;
}

.sp-speak-btn.sp-speaking {
    background: var(--sp-accent);
    border-color: var(--sp-accent);
    color: white;
    animation: sp-pulse 1s ease-in-out infinite;
}

/* Apply Swipe Button (Guided Generations integration) */
.sp-apply-swipe {
    background: transparent;
    border: 1px solid var(--sp-border);
    border-radius: var(--sp-radius);
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity var(--sp-transition), background var(--sp-transition), border-color var(--sp-transition);
}

.sp-apply-swipe:hover:not(:disabled) {
    opacity: 1;
    background: var(--sp-accent);
    border-color: var(--sp-accent);
    color: white;
}

.sp-apply-swipe:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

@keyframes sp-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Failed Message */
.sp-message-failed {
    border-color: var(--sp-error);
}

.sp-error-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--sp-error);
    margin-bottom: 0.5rem;
}

.sp-error-icon {
    font-size: 1rem;
}

.sp-retry-btn {
    background: transparent;
    border: 1px solid var(--sp-error);
    color: var(--sp-error);
}

.sp-retry-btn:hover {
    background: var(--sp-error);
    color: white;
}

/* ========================================
   Input Container (Conversation)
   ======================================== */
.sp-input-container {
    padding: 0.75rem 1rem;
    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
    background: var(--sp-bg-secondary);
    border-top: 1px solid var(--sp-border);
    flex-shrink: 0;
    position: relative;
}

.sp-input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

.sp-message-input {
    flex: 1;
    padding: 0.75rem;
    background: var(--sp-bg-tertiary);
    border: 1px solid var(--sp-border);
    border-radius: var(--sp-radius);
    color: var(--sp-text-primary);
    font-size: var(--sp-text-size);
    resize: none;
    min-height: var(--sp-min-touch-target);
    max-height: 9.375rem;
    line-height: 1.4;
}

.sp-message-input:focus {
    outline: none;
    border-color: var(--sp-accent);
}

.sp-message-input::placeholder {
    color: var(--sp-text-muted);
}

.sp-send-btn {
    flex-shrink: 0;
}

/* ========================================
   Spinner
   ======================================== */
.sp-spinner {
    display: flex;
    gap: 0.25rem;
    padding: 0.5rem 0;
}

.sp-spinner-dot {
    width: 0.5rem;
    height: 0.5rem;
    background: var(--sp-accent);
    border-radius: 50%;
    animation: sp-bounce 1.4s infinite ease-in-out both;
    will-change: transform;
}

.sp-spinner-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.sp-spinner-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes sp-bounce {

    0%,
    80%,
    100% {
        transform: scale(0);
    }

    40% {
        transform: scale(1);
    }
}

/* ========================================
   Popup / Bottom Sheet
   ======================================== */
.sp-popup {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    min-height: 100vh;
    min-height: 100dvh;
    box-sizing: border-box;
    z-index: 2147483647;
    isolation: isolate;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.sp-popup.sp-popup-visible {
    opacity: 1;
    pointer-events: auto;
}

.sp-popup.sp-popup-hiding .sp-popup-sheet {
    transform: translateY(100%);
}

.sp-popup-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
}

.sp-popup-sheet {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--sp-bg-primary);
    border-radius: var(--sp-radius-lg) var(--sp-radius-lg) 0 0;
    max-height: 70vh;
    max-height: 70dvh;
    min-height: 12.5rem;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    box-shadow: 0 -0.25rem 1.25rem rgba(0, 0, 0, 0.4);
    padding-bottom: env(safe-area-inset-bottom);
}

.sp-popup.sp-popup-visible .sp-popup-sheet {
    transform: translateY(0);
}

/* Mobile popup adjustments */
@media (max-width: 30rem) {
    .sp-popup-sheet {
        max-height: 80dvh;
        min-height: 9.375rem;
    }

    .sp-popup-actions {
        padding: 0.75rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .sp-popup-actions .sp-button {
        flex: 1 1 45%;
        min-width: 7.5rem;
    }
}

.sp-popup-drag-handle {
    display: flex;
    justify-content: center;
    padding: 0.75rem;
    cursor: grab;
}

.sp-drag-indicator {
    width: 2.5rem;
    height: 0.25rem;
    background: var(--sp-border);
    border-radius: 0.125rem;
}

.sp-popup-header {
    padding: 0 1rem 1rem;
    border-bottom: 1px solid var(--sp-border);
}

.sp-popup-title {
    font-size: calc(var(--sp-text-size) * 1.1);
    font-weight: 600;
    color: var(--sp-text-primary);
}

.sp-popup-subtitle {
    font-size: calc(var(--sp-text-size) * 0.7);
    color: var(--sp-accent);
    text-transform: uppercase;
    letter-spacing: 0.03rem;
}

.sp-popup-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    min-height: 6.25rem;
}

.sp-popup-response {
    font-size: var(--sp-text-size);
    line-height: 1.6;
    color: var(--sp-text-primary);
}

.sp-popup-response p {
    margin: 0 0 0.75rem 0;
}

.sp-popup-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--sp-error);
}

.sp-popup-actions {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    border-top: 1px solid var(--sp-border);
}

.sp-popup-open-btn {
    flex: 1;
}

.sp-popup-dismiss-btn {
    flex: 1;
    background: var(--sp-bg-tertiary);
    border: 1px solid var(--sp-border);
}

.sp-popup-dismiss-btn:hover {
    background: var(--sp-bg-secondary);
}

.sp-popup-cancel-btn {
    flex: 1;
    background: transparent;
    border: 1px solid var(--sp-text-muted);
    color: var(--sp-text-muted);
}

.sp-popup-cancel-btn:hover {
    background: var(--sp-error);
    border-color: var(--sp-error);
    color: white;
}

.sp-popup-cancelled {
    color: var(--sp-text-muted);
    font-style: italic;
}

/* ========================================
   Load More Button
   ======================================== */
.sp-load-more-btn {
    width: 100%;
    background: var(--sp-bg-secondary);
    border: 1px dashed var(--sp-border);
    color: var(--sp-text-secondary);
    margin-bottom: 1rem;
}

.sp-load-more-btn:hover {
    background: var(--sp-bg-tertiary);
    color: var(--sp-text-primary);
}

/* ========================================
   Settings Panel
   ======================================== */
.scratch-pad-settings .inline-drawer-content {
    padding: 0.625rem;
}

.scratch_pad_settings_block {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.scratch_pad_settings_block h4 {
    margin: 0.5rem 0 0.25rem 0;
    color: var(--sp-accent);
}

.scratch_pad_settings_block label {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.scratch_pad_settings_block label small {
    color: var(--sp-text-muted);
    font-size: 0.6875rem;
}

.scratch_pad_settings_block .checkbox_label {
    flex-direction: row;
    align-items: flex-start;
    gap: 0.5rem;
}

.scratch_pad_settings_block .checkbox_label span {
    display: block;
}

.scratch_pad_settings_block .range-block {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.scratch_pad_settings_block .range-block input[type="range"] {
    flex: 1;
}

.scratch_pad_settings_block hr {
    border: none;
    border-top: 1px solid var(--sp-border);
    margin: 0.5rem 0;
}

.sp-drawer-settings {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--sp-border);
    background: var(--sp-bg-secondary);
}

.sp-settings-details {
    color: var(--sp-text-primary);
}

.sp-settings-details summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--sp-accent);
    list-style: none;
}

.sp-settings-details summary::-webkit-details-marker {
    display: none;
}

.sp-settings-details summary::after {
    content: '▾';
    float: right;
    color: var(--sp-text-muted);
    transition: transform var(--sp-transition);
}

.sp-settings-details[open] summary::after {
    transform: rotate(180deg);
}

.sp-drawer-settings-block {
    margin-top: 0.75rem;
}

/* ========================================
   Context Options (Conversation View)
   ======================================== */
.sp-context-options {
    padding: 0.5rem 1rem;
    background: var(--sp-bg-secondary);
    border-bottom: 1px solid var(--sp-border);
    flex-shrink: 0;
}

.sp-context-summary {
    font-size: 0.75rem;
    color: var(--sp-text-secondary);
    padding: 0.25rem 0.5rem;
    background: var(--sp-bg-tertiary);
    border-radius: var(--sp-radius);
    display: inline-block;
    margin-bottom: 0.5rem;
}

.sp-context-details {
    color: var(--sp-text-primary);
}

.sp-context-details summary {
    cursor: pointer;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--sp-accent);
    list-style: none;
    user-select: none;
}

.sp-context-details summary::-webkit-details-marker {
    display: none;
}

.sp-context-details summary::before {
    content: '▶';
    font-size: 0.625rem;
    margin-right: 0.5rem;
    transition: transform var(--sp-transition);
    display: inline-block;
}

.sp-context-details[open] summary::before {
    transform: rotate(90deg);
}

.sp-context-options-block {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
}

.sp-context-options-block label {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    font-size: 0.8125rem;
    color: var(--sp-text-primary);
}

.sp-context-options-block label small {
    color: var(--sp-text-muted);
    font-size: 0.6875rem;
}

.sp-context-options-block .checkbox_label {
    flex-direction: row;
    align-items: flex-start;
    gap: 0.5rem;
}

.sp-context-options-block .checkbox_label input[type="checkbox"] {
    margin-top: 0.125rem;
}

.sp-context-options-block .checkbox_label span {
    display: block;
}

.sp-context-options-block .range-block {
    margin-top: 0.25rem;
}

.sp-context-options-block select.text_pole,
.sp-context-options-block input.text_pole {
    padding: 0.5rem;
    font-size: 0.8125rem;
    background: var(--sp-bg-tertiary);
    border: 1px solid var(--sp-border);
    border-radius: var(--sp-radius);
    color: var(--sp-text-primary);
}

.sp-context-options-block select.text_pole:focus,
.sp-context-options-block input.text_pole:focus {
    outline: none;
    border-color: var(--sp-accent);
}

.sp-context-options-block .flex-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
}

.sp-context-options-block .flex-container input[type="number"] {
    flex: 1;
    min-width: 0;
}

.sp-context-options-block .flex-container span {
    color: var(--sp-text-muted);
    font-size: 0.75rem;
}

/* Context badges row */
.sp-context-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Profile badge in conversation view */
.sp-profile-badge {
    font-size: 0.75rem;
    color: var(--sp-accent);
    padding: 0.25rem 0.5rem;
    background: color-mix(in srgb, var(--sp-accent) 15%, var(--sp-bg-tertiary));
    border: 1px solid color-mix(in srgb, var(--sp-accent) 40%, var(--sp-border));
    border-radius: var(--sp-radius);
    display: inline-block;
}

/* Profile indicator in thread list */
.sp-thread-profile-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--sp-accent);
    flex-shrink: 0;
    margin-left: 0.25rem;
}

/* ========================================
   Generating Indicator
   ======================================== */
.sp-generating-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: var(--sp-accent);
    font-size: 0.8125rem;
    animation: sp-pulse 1.5s ease-in-out infinite;
}

.sp-generating-spinner {
    width: 0.875rem;
    height: 0.875rem;
    border: 2px solid var(--sp-border);
    border-top-color: var(--sp-accent);
    border-radius: 50%;
    animation: sp-spin 0.8s linear infinite;
    will-change: transform;
}

@keyframes sp-spin {
    to {
        transform: rotate(360deg);
    }
}

@keyframes sp-pulse {

    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.6;
    }
}

.sp-input-container.sp-generating .sp-input-wrapper {
    opacity: 0.6;
}

.sp-input-container.sp-generating .sp-message-input {
    cursor: not-allowed;
}

/* Cancel button in generating indicator */
.sp-cancel-btn {
    margin-left: auto;
    padding: 0.25rem 0.5rem;
    min-height: var(--sp-min-touch-target);
    font-size: 0.75rem;
    background: transparent;
    border: 1px solid var(--sp-text-muted);
    color: var(--sp-text-muted);
    border-radius: var(--sp-radius);
    cursor: pointer;
    transition: all 0.2s ease;
    animation: none;
}

.sp-cancel-btn:hover {
    background: var(--sp-error);
    border-color: var(--sp-error);
    color: white;
}

/* ========================================
   Scrollbar Styling
   ======================================== */
.sp-messages::-webkit-scrollbar,
.sp-thread-list::-webkit-scrollbar,
.sp-popup-content::-webkit-scrollbar {
    width: 0.375rem;
}

.sp-messages::-webkit-scrollbar-track,
.sp-thread-list::-webkit-scrollbar-track,
.sp-popup-content::-webkit-scrollbar-track {
    background: transparent;
}

.sp-messages::-webkit-scrollbar-thumb,
.sp-thread-list::-webkit-scrollbar-thumb,
.sp-popup-content::-webkit-scrollbar-thumb {
    background: var(--sp-border);
    border-radius: 0.1875rem;
}

.sp-messages::-webkit-scrollbar-thumb:hover,
.sp-thread-list::-webkit-scrollbar-thumb:hover,
.sp-popup-content::-webkit-scrollbar-thumb:hover {
    background: var(--sp-text-muted);
}

/* ========================================
   Thinking Section (Collapsible)
   ======================================== */
.sp-thinking {
    background: rgba(99, 102, 241, 0.08);
    border-left: 3px solid var(--sp-accent);
    border-radius: var(--sp-radius);
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 0.8125rem;
}

.sp-thinking summary {
    cursor: pointer;
    font-weight: 500;
    color: var(--sp-accent);
    user-select: none;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0;
}

.sp-thinking summary:hover {
    color: var(--sp-accent-hover);
}

.sp-thinking summary::-webkit-details-marker,
.sp-thinking summary::marker {
    display: none;
    content: "";
}

.sp-thinking summary::before {
    content: "▶";
    font-size: 0.625rem;
    transition: transform 0.2s ease;
}

.sp-thinking[open] summary::before {
    transform: rotate(90deg);
}

.sp-thinking-content {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--sp-border);
    color: var(--sp-text-secondary);
    line-height: 1.5;
}

.sp-thinking-content p {
    margin: 0 0 0.5rem 0;
}

.sp-thinking-content p:last-child {
    margin-bottom: 0;
}

.sp-thinking-hidden {
    background: color-mix(in srgb, var(--sp-bg-secondary) 80%, var(--sp-border) 20%);
    border-left: 3px solid var(--sp-border);
    border-radius: var(--sp-radius);
    color: var(--sp-text-secondary);
    font-size: 0.8125rem;
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
}

/* ========================================
   Branched Messages (Collapsible)
   ======================================== */
.sp-branched-messages {
    background: color-mix(in srgb, var(--sp-accent) 5%, var(--sp-bg-secondary));
    border-left: 3px solid var(--sp-text-muted);
    border-radius: var(--sp-radius);
    padding: 0.5rem 0.75rem;
    margin-top: 0.5rem;
}

.sp-branched-messages summary {
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8125rem;
    color: var(--sp-text-muted);
    user-select: none;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0;
    list-style: none;
}

.sp-branched-messages summary:hover {
    color: var(--sp-text-secondary);
}

.sp-branched-messages summary::-webkit-details-marker,
.sp-branched-messages summary::marker {
    display: none;
    content: "";
}

.sp-branched-messages summary::before {
    content: "▶";
    font-size: 0.625rem;
    transition: transform 0.2s ease;
}

.sp-branched-messages[open] summary::before {
    transform: rotate(90deg);
}

.sp-branched-messages-content {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--sp-border);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    opacity: 0.7;
}

/* ========================================
   Off-Branch Threads (Thread List Collapsible)
   ======================================== */
.sp-offbranch-threads {
    background: color-mix(in srgb, var(--sp-accent) 5%, var(--sp-bg-secondary));
    border-left: 3px solid var(--sp-text-muted);
    border-radius: var(--sp-radius);
    padding: 0.5rem 0.75rem;
    margin-top: 0.5rem;
}

.sp-offbranch-threads summary {
    cursor: pointer;
    font-weight: 500;
    font-size: 0.8125rem;
    color: var(--sp-text-muted);
    user-select: none;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0;
    list-style: none;
}

.sp-offbranch-threads summary:hover {
    color: var(--sp-text-secondary);
}

.sp-offbranch-threads summary::-webkit-details-marker,
.sp-offbranch-threads summary::marker {
    display: none;
    content: "";
}

.sp-offbranch-threads summary::before {
    content: "▶";
    font-size: 0.625rem;
    transition: transform 0.2s ease;
}

.sp-offbranch-threads[open] summary::before {
    transform: rotate(90deg);
}

.sp-offbranch-threads-content {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--sp-border);
    display: flex;
    flex-direction: column;
    gap: 0;
    opacity: 0.7;
}

/* ========================================
   Accessibility
   ======================================== */
.sp-button:focus-visible,
.sp-quick-input:focus-visible,
.sp-message-input:focus-visible,
.sp-thread-item:focus-visible,
.sp-thread-main:focus-visible,
.sp-swipe-arrow:focus-visible,
.sp-context-details summary:focus-visible,
.sp-settings-details summary:focus-visible {
    outline: 2px solid var(--sp-accent);
    outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {

    .sp-drawer,
    .sp-popup,
    .sp-popup-sheet,
    .sp-message,
    .sp-thread-item,
    .sp-button {
        transition: none;
    }

    .sp-spinner-dot {
        animation: none;
    }

    @keyframes sp-message-in {

        from,
        to {
            opacity: 1;
            transform: none;
        }
    }
}

/* Cancelled Message */
.sp-cancelled-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--sp-text-muted);
    font-style: italic;
}

/* Header button (pin, etc.) */
.sp-header-btn {
    background: transparent;
    color: var(--sp-text-secondary);
    padding: 0.5rem;
}

/* Button text span */
.sp-button-text {
    white-space: nowrap;
}

/* Empty/branched preview in thread list */
.sp-thread-preview-empty,
.sp-thread-preview-branched {
    font-style: italic;
    color: var(--sp-text-muted);
}

/* Rename button in thread list */
.sp-rename-btn {
    background: transparent;
    color: var(--sp-text-secondary);
}

.sp-rename-btn:hover {
    color: var(--sp-text-primary);
}

/* ========================================
   Swipe Controls
   ======================================== */
.sp-swipe-wrapper {
    display: flex;
    flex-direction: row;
    align-items: stretch;
}

.sp-swipe-wrapper .sp-message-content {
    flex: 1;
    min-width: 0;
}

.sp-swipe-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--sp-min-touch-target);
    min-width: var(--sp-min-touch-target);
    min-height: var(--sp-min-touch-target);
    padding: 0;
    background: transparent;
    border: none;
    color: var(--sp-text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0;
    transition: opacity var(--sp-transition), color var(--sp-transition);
    flex-shrink: 0;
}

.sp-message:hover .sp-swipe-arrow:not(.sp-swipe-hidden) {
    opacity: 1;
}

.sp-swipe-arrow:hover:not(:disabled) {
    color: var(--sp-text-primary);
}

.sp-swipe-arrow:disabled {
    opacity: 0 !important;
    cursor: default;
}

.sp-message:hover .sp-swipe-arrow:disabled:not(.sp-swipe-hidden) {
    opacity: 0.3 !important;
    cursor: not-allowed;
}

.sp-swipe-arrow.sp-swipe-hidden {
    opacity: 0;
    pointer-events: none;
}

.sp-message:hover .sp-swipe-arrow.sp-swipe-hidden {
    opacity: 0.4;
    pointer-events: auto;
}

.sp-swipe-arrow.sp-swipe-generate:not(:disabled) {
    color: var(--sp-accent);
}

.sp-swipe-arrow.sp-swipe-generate:hover:not(:disabled) {
    color: var(--sp-accent-hover);
}

.sp-swipe-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.125rem 0;
}

.sp-swipe-counter {
    font-size: 0.6875rem;
    color: var(--sp-text-muted);
    user-select: none;
}

.sp-swipe-delete {
    background: transparent;
    border: none;
    color: var(--sp-text-muted);
    padding: 0.25rem 0.5rem;
    font-size: 0.6875rem;
    min-height: var(--sp-min-touch-target);
    opacity: 0;
    transition: opacity var(--sp-transition), color var(--sp-transition);
    cursor: pointer;
}

.sp-message:hover .sp-swipe-delete {
    opacity: 0.6;
}

.sp-swipe-delete:hover {
    color: var(--sp-error) !important;
    opacity: 1 !important;
}

/* Touch devices - always show swipe controls and message actions */
@media (hover: none) and (pointer: coarse) {
    .sp-message-actions {
        opacity: 1;
    }

    .sp-swipe-arrow:not(.sp-swipe-hidden):not(:disabled) {
        opacity: 1;
    }

    .sp-swipe-arrow:disabled:not(.sp-swipe-hidden) {
        opacity: 0.3;
    }

    .sp-swipe-arrow.sp-swipe-hidden {
        opacity: 0.4;
        pointer-events: auto;
    }

    .sp-swipe-delete {
        opacity: 0.6;
    }
}

/* Mobile-specific layout adjustments */
@media (max-width: 30rem) {
    .sp-context-options {
        flex-shrink: 1;
        max-height: 40vh;
        overflow-y: auto;
    }

    .sp-message-input {
        max-height: 5rem;
    }
}
